{% extends "base.html" %}

{% block content %}
<section class="page-section">
  <div class="page-toolbar">
    <div>
      <h2>激活记录</h2>
      <p class="toolbar-subtitle">查看激活码使用情况与渠道效果</p>
    </div>
    <div class="toolbar-actions">
      <input id="activation-search" class="input input-sm" placeholder="搜索激活码 / SN / 渠道">
      <select id="activation-status" class="input input-sm">
        <option value="">全部状态</option>
        <option value="active">活跃</option>
        <option value="inactive">待用</option>
        <option value="used">已使用</option>
        <option value="expired">已过期</option>
      </select>
      <button class="btn secondary" id="activation-export">导出 CSV</button>
      <button class="btn" id="activation-generate">批量生成</button>
    </div>
  </div>

  <div class="card">
    <div class="table-responsive">
      <table class="table" id="activation-table">
        <thead>
          <tr>
            <th>激活码</th>
            <th>状态</th>
            <th>渠道</th>
            <th>设备 SN</th>
            <th>创建时间</th>
            <th>激活时间</th>
            <th>过期时间</th>
            <th class="text-right">操作</th>
          </tr>
        </thead>
        <tbody id="activation-tbody">
          <tr><td colspan="8" class="text-center text-muted">加载中...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<dialog id="activation-modal" class="modal">
  <form method="dialog" class="modal-content" id="activation-form">
    <header class="modal-header">
      <h3>批量生成激活码</h3>
      <button type="button" class="modal-close" data-action="close">×</button>
    </header>
    <div class="modal-body">
      <label class="form-field">
        <span>渠道</span>
        <select id="generate-channel" required></select>
      </label>
      <label class="form-field">
        <span>数量</span>
        <input type="number" id="generate-count" min="1" max="500" value="10" required>
      </label>
      <label class="form-field">
        <span>最大使用次数</span>
        <input type="number" id="generate-max" min="1" value="1" required>
      </label>
      <label class="form-field">
        <span>过期日期 (可选)</span>
        <input type="date" id="generate-expire">
      </label>
    </div>
    <footer class="modal-footer">
      <button type="button" class="btn secondary" data-action="close">取消</button>
      <button type="submit" class="btn">生成</button>
    </footer>
  </form>
</dialog>

<dialog id="activation-detail" class="modal">
  <form method="dialog" class="modal-content">
    <header class="modal-header">
      <h3>激活详情</h3>
      <button type="button" class="modal-close" data-action="close">×</button>
    </header>
    <div class="modal-body" id="activation-detail-body"></div>
    <footer class="modal-footer">
      <button type="button" class="btn" data-action="close">关闭</button>
    </footer>
  </form>
</dialog>

<script type="module">
import { apiGet, apiPost, apiDownload, showNotification, formatDate } from "{{ url_for('static', path='assets/common.js') }}";

const state = {
  activations: [],
  channels: [],
  filters: {
    search: '',
    status: '',
  },
};

const tableBody = document.getElementById('activation-tbody');
const searchInput = document.getElementById('activation-search');
const statusSelect = document.getElementById('activation-status');
const exportBtn = document.getElementById('activation-export');
const generateBtn = document.getElementById('activation-generate');
const modal = document.getElementById('activation-modal');
const form = document.getElementById('activation-form');
const channelSelect = document.getElementById('generate-channel');
const detailModal = document.getElementById('activation-detail');
const detailBody = document.getElementById('activation-detail-body');

function toggleDialog(dialog, open) {
  if (!dialog) return;
  open ? dialog.showModal() : dialog.close();
}

modal.addEventListener('click', (event) => {
  if (event.target.dataset.action === 'close' || event.target === modal) {
    toggleDialog(modal, false);
  }
});

detailModal.addEventListener('click', (event) => {
  if (event.target.dataset.action === 'close' || event.target === detailModal) {
    toggleDialog(detailModal, false);
  }
});

async function loadChannels() {
  const res = await apiGet('/api/channels');
  state.channels = res.data || [];
  channelSelect.innerHTML = state.channels.map((item) => `<option value="${item.id}">${item.name} (${item.channel_code})</option>`).join('');
}

async function loadActivations() {
  const res = await apiGet('/api/activations');
  state.activations = res.data || [];
  renderTable();
}

function applyFilters(list) {
  return list.filter((item) => {
    const { search, status } = state.filters;
    const keyword = search.trim().toLowerCase();
    if (keyword) {
      const target = `${item.activation_code} ${item.sn || ''} ${item.channel_code || ''}`.toLowerCase();
      if (!target.includes(keyword)) return false;
    }
    if (status) {
      if (status === 'used' && !(item.used_count > 0)) return false;
      if (status === 'inactive' && item.status !== 'inactive') return false;
      if (status === 'active' && !(item.status === 'active' && item.used_count === 0)) return false;
      if (status === 'expired') {
        const expires = item.expires_at ? new Date(item.expires_at) : null;
        if (!expires || expires >= new Date()) return false;
      }
    }
    return true;
  });
}

function renderTable() {
  const rows = applyFilters(state.activations);
  if (!rows.length) {
    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暂无数据</td></tr>';
    return;
  }

  tableBody.innerHTML = rows.map((item) => {
    const shortCode = `${item.activation_code.slice(0, 6)}…`;
    const statusTag = item.status === 'active'
      ? '<span class="badge lv-info">活跃</span>'
      : '<span class="badge lv-warn">禁用</span>';
    const used = item.used_count > 0 ? '<span class="badge lv-info">已使用</span>' : '<span class="badge">待用</span>';
    return `
      <tr data-code="${item.activation_code}">
        <td><code>${shortCode}</code></td>
        <td>${statusTag} ${used}</td>
        <td>${item.channel_name || '-'}</td>
        <td>${item.sn || '-'}</td>
        <td>${item.created_at ? formatDate(item.created_at) : '-'}</td>
        <td>${item.activated_at ? formatDate(item.activated_at) : '-'}</td>
        <td>${item.expires_at ? formatDate(item.expires_at) : '-'}</td>
        <td class="text-right">
          <button class="btn secondary btn-xs" data-action="detail">详情</button>
        </td>
      </tr>
    `;
  }).join('');
}

searchInput.addEventListener('input', (event) => {
  state.filters.search = event.target.value;
  renderTable();
});

statusSelect.addEventListener('change', (event) => {
  state.filters.status = event.target.value;
  renderTable();
});

generateBtn.addEventListener('click', () => {
  if (!state.channels.length) {
    showNotification('请先创建渠道', 'warning');
    return;
  }
  form.reset();
  toggleDialog(modal, true);
});

form.addEventListener('submit', async (event) => {
  event.preventDefault();
  const payload = {
    channel_id: Number(channelSelect.value),
    count: Number(document.getElementById('generate-count').value || 1),
    max_uses: Number(document.getElementById('generate-max').value || 1),
  };
  const expireValue = document.getElementById('generate-expire').value;
  if (expireValue) {
    payload.expires_at = `${expireValue}T00:00:00`;
  }
  try {
    const res = await apiPost('/api/activations/generate', payload);
    showNotification(`成功生成 ${res.data.count} 个激活码`, 'success');
    toggleDialog(modal, false);
    await loadActivations();
  } catch (error) {
    showNotification(error.message, 'error');
  }
});

tableBody.addEventListener('click', (event) => {
  if (event.target.dataset.action !== 'detail') return;
  const code = event.target.closest('tr')?.dataset.code;
  const item = state.activations.find((row) => row.activation_code === code);
  if (!item) return;
  detailBody.innerHTML = `
    <dl class="modal-dl">
      <dt>激活码</dt><dd><code>${item.activation_code}</code></dd>
      <dt>渠道</dt><dd>${item.channel_name || '-'} (${item.channel_code || '-'})</dd>
      <dt>设备 SN</dt><dd>${item.sn || '-'}</dd>
      <dt>状态</dt><dd>${item.status}</dd>
      <dt>使用次数</dt><dd>${item.used_count || 0}/${item.max_uses || 1}</dd>
      <dt>创建时间</dt><dd>${item.created_at ? formatDate(item.created_at) : '-'}</dd>
      <dt>激活时间</dt><dd>${item.activated_at ? formatDate(item.activated_at) : '-'}</dd>
      <dt>过期时间</dt><dd>${item.expires_at ? formatDate(item.expires_at) : '-'}</dd>
      <dt>客户信息</dt><dd>${item.client_meta || '-'}</dd>
    </dl>
  `;
  toggleDialog(detailModal, true);
});

exportBtn.addEventListener('click', async () => {
  try {
    const res = await apiDownload('/api/activations/export');
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'activations.csv';
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);
    showNotification('导出完成', 'success');
  } catch (error) {
    showNotification(error.message, 'error');
  }
});

Promise.all([loadChannels(), loadActivations()]).catch((error) => showNotification(error.message, 'error'));
</script>
{% endblock %}
