{% extends "base.html" %}

{% block content %}
<section class="page-section">
  <div class="page-toolbar">
    <div>
      <h2>用户管理</h2>
      <p class="toolbar-subtitle">维护平台管理员账户、权限与状态</p>
    </div>
    <div class="toolbar-actions">
      <input id="user-search" class="input input-sm" placeholder="搜索用户名">
      <select id="user-status" class="input input-sm">
        <option value="">全部状态</option>
        <option value="active">启用</option>
        <option value="inactive">禁用</option>
      </select>
      <select id="user-role" class="input input-sm">
        <option value="">全部角色</option>
        <option value="1">管理员</option>
        <option value="0">普通用户</option>
      </select>
      <button class="btn" id="user-create">新建用户</button>
    </div>
  </div>

  <div class="grid cols-4" id="user-stat-cards">
    <div class="kpi">
      <div class="kpi-label">总用户数</div>
      <div class="kpi-value" id="stat-total">0</div>
      <div class="kpi-pill">活跃 <span class="ok" id="stat-active">0</span></div>
    </div>
    <div class="kpi">
      <div class="kpi-label">管理员账户</div>
      <div class="kpi-value" id="stat-admin">0</div>
      <div class="kpi-pill">普通用户 <span class="warn" id="stat-regular">0</span></div>
    </div>
    <div class="kpi">
      <div class="kpi-label">启用状态</div>
      <div class="kpi-value" id="stat-enabled">0</div>
      <div class="kpi-pill">禁用 <span class="danger" id="stat-disabled">0</span></div>
    </div>
    <div class="kpi">
      <div class="kpi-label">今日登录</div>
      <div class="kpi-value" id="stat-today">0</div>
      <div class="kpi-pill">请关注异常登录</div>
    </div>
  </div>

  <div class="card">
    <div class="table-responsive">
      <table class="table" id="user-table">
        <thead>
          <tr>
            <th>用户名</th>
            <th>角色</th>
            <th>状态</th>
            <th>创建时间</th>
            <th>最后登录</th>
            <th class="text-right">操作</th>
          </tr>
        </thead>
        <tbody id="user-tbody">
          <tr><td colspan="6" class="text-center text-muted">加载中...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<dialog id="user-modal" class="modal">
  <form method="dialog" class="modal-content" id="user-form">
    <header class="modal-header">
      <h3 id="user-modal-title">新建用户</h3>
      <button type="button" class="modal-close" data-action="close">×</button>
    </header>
    <div class="modal-body">
      <label class="form-field">
        <span>用户名</span>
        <input type="text" id="user-username" maxlength="50" required>
      </label>
      <label class="form-field">
        <span>密码</span>
        <input type="password" id="user-password" maxlength="100" placeholder="至少 6 位字符" required>
        <span class="small text-muted" id="user-password-hint">创建用户时必填，编辑时留空表示不修改</span>
      </label>
      <label class="form-field">
        <span>角色</span>
        <select id="user-role-flag">
          <option value="true">管理员</option>
          <option value="false">普通用户</option>
        </select>
      </label>
      <label class="form-field">
        <span>状态</span>
        <select id="user-status-flag">
          <option value="active">启用</option>
          <option value="inactive">禁用</option>
        </select>
      </label>
    </div>
    <footer class="modal-footer">
      <button type="button" class="btn secondary" data-action="close">取消</button>
      <button type="submit" class="btn" id="user-submit">保存</button>
    </footer>
  </form>
</dialog>

<script type="module">
import { apiGet, apiPost, apiPut, apiDelete, showNotification, formatDate } from "{{ url_for('static', path='assets/common.js') }}";

const state = {
  users: [],
  editingId: null,
  filters: {
    search: '',
    status: '',
    role: ''
  }
};

const tableBody = document.getElementById('user-tbody');
const searchInput = document.getElementById('user-search');
const statusSelect = document.getElementById('user-status');
const roleSelect = document.getElementById('user-role');
const createBtn = document.getElementById('user-create');

const modal = document.getElementById('user-modal');
const form = document.getElementById('user-form');
const modalTitle = document.getElementById('user-modal-title');
const usernameInput = document.getElementById('user-username');
const passwordInput = document.getElementById('user-password');
const passwordHint = document.getElementById('user-password-hint');
const roleFlag = document.getElementById('user-role-flag');
const statusFlag = document.getElementById('user-status-flag');
const submitBtn = document.getElementById('user-submit');

const statTotal = document.getElementById('stat-total');
const statAdmin = document.getElementById('stat-admin');
const statRegular = document.getElementById('stat-regular');
const statEnabled = document.getElementById('stat-enabled');
const statDisabled = document.getElementById('stat-disabled');
const statActive = document.getElementById('stat-active');
const statToday = document.getElementById('stat-today');

function toggleDialog(dialog, open) {
  if (!dialog) return;
  open ? dialog.showModal() : dialog.close();
}

function resetForm() {
  form.reset();
  passwordInput.required = true;
  passwordHint.textContent = '创建用户时必填，编辑时留空表示不修改';
  submitBtn.textContent = '保存';
}

modal.addEventListener('click', (event) => {
  if (event.target.dataset.action === 'close' || event.target === modal) {
    toggleDialog(modal, false);
  }
});

modal.addEventListener('close', () => {
  state.editingId = null;
  resetForm();
});

createBtn.addEventListener('click', () => {
  state.editingId = null;
  modalTitle.textContent = '新建用户';
  resetForm();
  toggleDialog(modal, true);
  usernameInput.focus();
});

function renderStats(stats) {
  statTotal.textContent = stats.total_users ?? 0;
  statAdmin.textContent = stats.admin_count ?? 0;
  statActive.textContent = stats.active_users ?? 0;
  statEnabled.textContent = stats.active_users ?? 0;
  statDisabled.textContent = (stats.total_users ?? 0) - (stats.active_users ?? 0);
  statRegular.textContent = (stats.total_users ?? 0) - (stats.admin_count ?? 0);
  statToday.textContent = stats.today_login ?? 0;
}

function renderTable() {
  if (!state.users.length) {
    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暂无用户数据</td></tr>';
    return;
  }

  tableBody.innerHTML = state.users.map((user) => {
    const roleBadge = user.is_admin
      ? '<span class="badge lv-info">管理员</span>'
      : '<span class="badge">普通用户</span>';
    const statusBadge = user.status === 'active'
      ? '<span class="badge lv-info">启用</span>'
      : '<span class="badge lv-warn">禁用</span>';
    const toggleStatusLabel = user.status === 'active' ? '禁用' : '启用';
    const toggleRoleLabel = user.is_admin ? '降为普通' : '设为管理员';

    return `
      <tr data-id="${user.id}">
        <td>${user.username}</td>
        <td>${roleBadge}</td>
        <td>${statusBadge}</td>
        <td>${user.created_at ? formatDate(user.created_at) : '-'}</td>
        <td>${user.last_login ? formatDate(user.last_login) : '-'}</td>
        <td class="text-right">
          <button class="btn secondary btn-xs" data-action="edit">编辑</button>
          <button class="btn btn-xs" data-action="toggle-admin">${toggleRoleLabel}</button>
          <button class="btn btn-xs" data-action="toggle-status">${toggleStatusLabel}</button>
          <button class="btn danger btn-xs" data-action="delete">删除</button>
        </td>
      </tr>
    `;
  }).join('');
}

async function loadStats() {
  try {
    const res = await apiGet('/users/statistics');
    renderStats(res);
  } catch (error) {
    showNotification(error.message, 'error');
  }
}

async function loadUsers() {
  try {
    const params = {
      page: 1,
      page_size: 100
    };
    if (state.filters.search) params.search = state.filters.search;
    if (state.filters.status) params.status = state.filters.status;
    if (state.filters.role) params.is_admin = state.filters.role === '1';

    const res = await apiGet('/users', params);
    state.users = res.items || [];
    renderTable();
  } catch (error) {
    state.users = [];
    renderTable();
    showNotification(error.message, 'error');
  }
}

searchInput.addEventListener('input', (event) => {
  state.filters.search = event.target.value.trim();
  loadUsers();
});

statusSelect.addEventListener('change', (event) => {
  state.filters.status = event.target.value;
  loadUsers();
});

roleSelect.addEventListener('change', (event) => {
  state.filters.role = event.target.value;
  loadUsers();
});

function fillForm(user) {
  usernameInput.value = user.username;
  roleFlag.value = String(user.is_admin);
  statusFlag.value = user.status;
  passwordInput.value = '';
  passwordInput.required = false;
  passwordHint.textContent = '留空表示保持原密码';
  submitBtn.textContent = '更新';
}

tableBody.addEventListener('click', async (event) => {
  const action = event.target.dataset.action;
  if (!action) return;
  const row = event.target.closest('tr');
  const id = Number(row?.dataset.id);
  if (!id) return;
  const user = state.users.find((item) => item.id === id);
  if (!user) return;

  if (action === 'edit') {
    state.editingId = id;
    modalTitle.textContent = '编辑用户';
    fillForm(user);
    toggleDialog(modal, true);
    usernameInput.focus();
    return;
  }

  if (action === 'toggle-status') {
    try {
      await apiPost(`/users/${id}/toggle-status`);
      showNotification('状态更新成功', 'success');
      await Promise.all([loadUsers(), loadStats()]);
    } catch (error) {
      showNotification(error.message, 'error');
    }
    return;
  }

  if (action === 'toggle-admin') {
    try {
      await apiPost(`/users/${id}/toggle-admin`);
      showNotification('角色更新成功', 'success');
      await Promise.all([loadUsers(), loadStats()]);
    } catch (error) {
      showNotification(error.message, 'error');
    }
    return;
  }

  if (action === 'delete') {
    if (!confirm(`确认删除用户 ${user.username} 吗？`)) return;
    try {
      await apiDelete(`/users/${id}`);
      showNotification('用户删除成功', 'success');
      await Promise.all([loadUsers(), loadStats()]);
    } catch (error) {
      showNotification(error.message, 'error');
    }
  }
});

form.addEventListener('submit', async (event) => {
  event.preventDefault();
  const payload = {
    username: usernameInput.value.trim(),
    is_admin: roleFlag.value === 'true',
    status: statusFlag.value
  };
  const password = passwordInput.value.trim();
  if (!state.editingId && password.length < 6) {
    showNotification('密码至少需要 6 位字符', 'warning');
    return;
  }
  if (password) {
    payload.password = password;
  }

  try {
    if (state.editingId) {
      await apiPut(`/users/${state.editingId}`, payload);
      showNotification('用户更新成功', 'success');
    } else {
      if (!payload.password) {
        showNotification('请设置初始密码', 'warning');
        return;
      }
      await apiPost('/users', payload);
      showNotification('用户创建成功', 'success');
    }
    toggleDialog(modal, false);
    await Promise.all([loadUsers(), loadStats()]);
  } catch (error) {
    showNotification(error.message, 'error');
  }
});

Promise.all([loadUsers(), loadStats()]).catch((error) => showNotification(error.message, 'error'));
</script>
{% endblock %}
