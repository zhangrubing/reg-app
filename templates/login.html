<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>!function(){try{const t=localStorage.getItem("theme");if(t){document.documentElement.setAttribute("data-theme",t);}else{const prefersLight=window.matchMedia&&window.matchMedia("(prefers-color-scheme: light)").matches;document.documentElement.setAttribute("data-theme",prefersLight?"light":"dark");}}catch(e){}}();</script>
  <link rel="stylesheet" href="{{ url_for('static', path='assets/style.css?v=2') }}">
  <title>{{ app_name }} Â· ç™»å½•</title>
</head>
<body class="login-body">
  <div class="login-hero">
    <div class="login-card" role="region" aria-labelledby="login-title">
      <div class="login-brand">
        <div class="login-logo">ğŸ”</div>
        <div>
          <div class="login-brand-name">{{ app_name }}</div>
          <div class="login-brand-desc">è½¯ä»¶æ³¨å†Œ Â· æ¿€æ´»åˆè§„ Â· æ¸ é“ç²¾ç»†åŒ–è¿è¥</div>
        </div>
      </div>
      <h1 id="login-title">ç®¡ç†å‘˜ç™»å½•</h1>
      <p class="login-subtitle">ä½¿ç”¨æ‚¨çš„ç®¡ç†å‘˜è´¦å·è¿›å…¥æ§åˆ¶å°ã€‚é»˜è®¤è´¦å·ï¼šadmin / admin123ã€‚</p>
      <form id="login-form" class="login-form">
        <label class="field-label" for="username">ç”¨æˆ·å</label>
        <input id="username" name="username" type="text" class="input" placeholder="è¾“å…¥ç”¨æˆ·å" autocomplete="username" required>
        <label class="field-label" for="password">å¯†ç </label>
        <input id="password" name="password" type="password" class="input" placeholder="è¾“å…¥å¯†ç " autocomplete="current-password" required>
        <div class="login-meta">
          <label class="checkbox">
            <input type="checkbox" id="remember-theme" checked>
            <span>è·Ÿéšç³»ç»Ÿä¸»é¢˜</span>
          </label>
          <a class="link-muted" href="mailto:support@example.com">å¿˜è®°å¯†ç ï¼Ÿ</a>
        </div>
        <button type="submit" class="btn w-full" id="login-submit">ç«‹å³ç™»å½•</button>
        <div class="login-error" id="login-error" role="alert" hidden></div>
      </form>
      <footer class="login-footer">
        <span>Â© {{ current_year }} {{ app_name }} Â· å®‰å…¨æ¿€æ´»ä¸å®¡è®¡å¹³å°</span>
      </footer>
    </div>
  </div>
<script type="module">
import { apiPost } from "{{ url_for('static', path='assets/common.js') }}";

const form = document.querySelector('#login-form');
const btn = document.querySelector('#login-submit');
const errorEl = document.querySelector('#login-error');
const usernameInput = document.querySelector('#username');
const passwordInput = document.querySelector('#password');
const rememberTheme = document.querySelector('#remember-theme');
const systemTheme = window.matchMedia('(prefers-color-scheme: light)');

usernameInput.focus();

function setLoading(state) {
  btn.disabled = state;
  btn.classList.toggle('btn-loading', state);
  btn.textContent = state ? 'æ­£åœ¨ç™»å½•â€¦' : 'ç«‹å³ç™»å½•';
}

function setTheme(value) {
  document.documentElement.setAttribute('data-theme', value);
}

function applySystemTheme() {
  setTheme(systemTheme.matches ? 'light' : 'dark');
}

function showError(message) {
  if (!message) {
    errorEl.hidden = true;
    return;
  }
  errorEl.textContent = message;
  errorEl.hidden = false;
}

rememberTheme.addEventListener('change', () => {
  try {
    if (rememberTheme.checked) {
      localStorage.removeItem('theme');
      applySystemTheme();
    } else {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      localStorage.setItem('theme', current);
    }
  } catch (_) {}
});

systemTheme.addEventListener?.('change', (event) => {
  if (rememberTheme.checked) {
    setTheme(event.matches ? 'light' : 'dark');
  }
});

if (rememberTheme.checked) {
  applySystemTheme();
}

form.addEventListener('submit', async (event) => {
  event.preventDefault();
  showError('');
  setLoading(true);
  try {
    await apiPost('/api/login', {
      username: usernameInput.value.trim(),
      password: passwordInput.value.trim()
    });
    window.location.href = '/dashboard';
  } catch (err) {
    const detail = err?.data?.detail || err?.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
    showError(`ç™»å½•å¤±è´¥ï¼š${detail}`);
    passwordInput.focus();
    passwordInput.select();
  } finally {
    setLoading(false);
  }
});
</script>
</body>
</html>
