{% extends "base.html" %}

{% block content %}
<section class="page-section">
  <div class="page-toolbar">
    <div>
      <h2>许可证列表</h2>
      <p class="toolbar-subtitle">管理许可证的有效期、吊销状态与关联信息</p>
    </div>
    <div class="toolbar-actions">
      <input id="license-search" class="input input-sm" placeholder="搜索 SN / 产品 / 激活码">
      <select id="license-status" class="input input-sm">
        <option value="">全部状态</option>
        <option value="active">活跃</option>
        <option value="expired">已过期</option>
        <option value="revoked">已吊销</option>
      </select>
      <button class="btn secondary" id="license-export">导出 CSV</button>
      <button class="btn" id="license-create">新建许可证</button>
    </div>
  </div>

  <div class="card">
    <div class="table-responsive">
      <table class="table" id="license-table">
        <thead>
          <tr>
            <th>SN</th>
            <th>产品</th>
            <th>状态</th>
            <th>签发时间</th>
            <th>过期时间</th>
            <th>关联激活</th>
            <th class="text-right">操作</th>
          </tr>
        </thead>
        <tbody id="license-tbody">
          <tr><td colspan="7" class="text-center text-muted">加载中...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<dialog id="license-modal" class="modal">
  <form method="dialog" class="modal-content" id="license-form">
    <header class="modal-header">
      <h3 id="license-modal-title">新建许可证</h3>
      <button type="button" class="modal-close" data-action="close">×</button>
    </header>
    <div class="modal-body">
      <input type="hidden" id="license-id">
      <label class="form-field">
        <span>设备 SN</span>
        <input type="text" id="license-sn" required maxlength="128">
      </label>
      <label class="form-field">
        <span>关联激活 ID（可选）</span>
        <input type="number" id="license-activation" min="0">
      </label>
      <label class="form-field">
        <span>产品名称</span>
        <input type="text" id="license-product" required maxlength="128">
      </label>
      <label class="form-field">
        <span>最大激活次数</span>
        <input type="number" id="license-max" min="1" value="1" required>
      </label>
      <label class="form-field">
        <span>有效期（天）</span>
        <input type="number" id="license-valid" min="1" value="365">
      </label>
      <label class="form-field">
        <span>备注</span>
        <textarea id="license-notes" rows="2" maxlength="500"></textarea>
      </label>
      <label class="form-field">
        <span>指定过期日期（可选）</span>
        <input type="date" id="license-expire">
      </label>
    </div>
    <footer class="modal-footer">
      <button type="button" class="btn secondary" data-action="close">取消</button>
      <button type="submit" class="btn">保存</button>
    </footer>
  </form>
</dialog>

<dialog id="license-detail" class="modal">
  <form method="dialog" class="modal-content">
    <header class="modal-header">
      <h3>许可证详情</h3>
      <button type="button" class="modal-close" data-action="close">×</button>
    </header>
    <div class="modal-body" id="license-detail-body"></div>
    <footer class="modal-footer">
      <button type="button" class="btn" data-action="close">关闭</button>
    </footer>
  </form>
</dialog>

<script type="module">
import { apiGet, apiPost, apiPut, apiDelete, apiDownload, showNotification, formatDate } from "{{ url_for('static', path='assets/common.js') }}";

const state = {
  licenses: [],
  filters: { search: '', status: '' },
  editingId: null,
};

const tableBody = document.getElementById('license-tbody');
const searchInput = document.getElementById('license-search');
const statusSelect = document.getElementById('license-status');
const createBtn = document.getElementById('license-create');
const exportBtn = document.getElementById('license-export');
const modal = document.getElementById('license-modal');
const form = document.getElementById('license-form');
const modalTitle = document.getElementById('license-modal-title');
const detailModal = document.getElementById('license-detail');
const detailBody = document.getElementById('license-detail-body');

const fieldSn = document.getElementById('license-sn');
const fieldActivation = document.getElementById('license-activation');
const fieldProduct = document.getElementById('license-product');
const fieldMax = document.getElementById('license-max');
const fieldValid = document.getElementById('license-valid');
const fieldNotes = document.getElementById('license-notes');
const fieldExpire = document.getElementById('license-expire');

function toggleDialog(dialog, open) {
  if (!dialog) return;
  open ? dialog.showModal() : dialog.close();
}

function resetForm() {
  form.reset();
  fieldValid.value = '';
  fieldExpire.value = '';
}

modal.addEventListener('click', (event) => {
  if (event.target.dataset.action === 'close' || event.target === modal) {
    toggleDialog(modal, false);
  }
});

modal.addEventListener('close', () => {
  resetForm();
  state.editingId = null;
});

detailModal.addEventListener('click', (event) => {
  if (event.target.dataset.action === 'close' || event.target === detailModal) {
    toggleDialog(detailModal, false);
  }
});

function renderTable() {
  if (!state.licenses.length) {
    tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无许可证数据</td></tr>';
    return;
  }

  tableBody.innerHTML = state.licenses.map((item) => {
    const statusTag = item.status === 'active'
      ? '<span class="badge lv-info">活跃</span>'
      : item.status === 'expired'
        ? '<span class="badge lv-warn">已过期</span>'
        : item.status === 'revoked'
          ? '<span class="badge lv-error">已吊销</span>'
          : '<span class="badge">未知</span>';

    return `
      <tr data-id="${item.id}">
        <td><code>${item.sn}</code></td>
        <td>${item.product_name || '-'}</td>
        <td>${statusTag}</td>
        <td>${item.issued_at ? formatDate(item.issued_at) : '-'}</td>
        <td>${item.expires_at ? formatDate(item.expires_at) : '-'}</td>
        <td>${item.activation_id || '-'}</td>
        <td class="text-right">
          <button class="btn secondary btn-xs" data-action="detail">详情</button>
          <button class="btn secondary btn-xs" data-action="edit">编辑</button>
          <button class="btn btn-xs" data-action="revoke">吊销</button>
          <button class="btn danger btn-xs" data-action="delete">删除</button>
        </td>
      </tr>
    `;
  }).join('');
}

function renderDetail(item) {
  detailBody.innerHTML = `
    <dl class="modal-dl">
      <dt>ID</dt><dd>${item.id}</dd>
      <dt>设备 SN</dt><dd><code>${item.sn}</code></dd>
      <dt>产品</dt><dd>${item.product_name || '-'}</dd>
      <dt>最大激活次数</dt><dd>${item.max_activations || '-'}</dd>
      <dt>状态</dt><dd>${item.status}</dd>
      <dt>签名</dt><dd><code>${item.signature}</code></dd>
      <dt>签发时间</dt><dd>${item.issued_at ? formatDate(item.issued_at) : '-'}</dd>
      <dt>过期时间</dt><dd>${item.expires_at ? formatDate(item.expires_at) : '-'}</dd>
      <dt>吊销时间</dt><dd>${item.revoked_at ? formatDate(item.revoked_at) : '-'}</dd>
      <dt>备注</dt><dd>${item.notes || '-'}</dd>
    </dl>
  `;
}

tableBody.addEventListener('click', async (event) => {
  const action = event.target.dataset.action;
  if (!action) return;

  const row = event.target.closest('tr');
  const id = Number(row?.dataset.id);
  const item = state.licenses.find((license) => license.id === id);
  if (!item) return;

  if (action === 'detail') {
    renderDetail(item);
    toggleDialog(detailModal, true);
    return;
  }

  if (action === 'edit') {
    state.editingId = id;
    modalTitle.textContent = '编辑许可证';
    fillForm(item);
    toggleDialog(modal, true);
    return;
  }

  if (action === 'revoke') {
    if (!confirm('确定要吊销该许可证吗？')) return;
    try {
      await apiPost(`/api/licenses/${id}/revoke`);
      showNotification('许可证已吊销', 'success');
      await loadLicenses();
    } catch (error) {
      showNotification(error.message, 'error');
    }
    return;
  }

  if (action === 'delete') {
    if (!confirm('确定要删除该许可证吗？')) return;
    try {
      await apiDelete(`/api/licenses/${id}`);
      showNotification('许可证已删除', 'success');
      await loadLicenses();
    } catch (error) {
      showNotification(error.message, 'error');
    }
  }
});

createBtn.addEventListener('click', () => {
  state.editingId = null;
  modalTitle.textContent = '新建许可证';
  resetForm();
  toggleDialog(modal, true);
});

function fillForm(item) {
  document.getElementById('license-id').value = item.id;
  fieldSn.value = item.sn || '';
  fieldActivation.value = item.activation_id || '';
  fieldProduct.value = item.product_name || '';
  fieldMax.value = item.max_activations || 1;
  fieldNotes.value = item.notes || '';
  fieldExpire.value = item.expires_at ? item.expires_at.split('T')[0] : '';
  fieldValid.value = '';
}

searchInput.addEventListener('input', (event) => {
  state.filters.search = event.target.value.trim();
  loadLicenses();
});

statusSelect.addEventListener('change', (event) => {
  state.filters.status = event.target.value;
  loadLicenses();
});

form.addEventListener('submit', async (event) => {
  event.preventDefault();
  const payload = {
    sn: fieldSn.value.trim(),
    activation_id: fieldActivation.value ? Number(fieldActivation.value) : null,
    product_name: fieldProduct.value.trim(),
    max_activations: Number(fieldMax.value || 1),
    valid_days: fieldValid.value ? Number(fieldValid.value) : undefined,
    notes: fieldNotes.value.trim(),
  };

  if (fieldExpire.value) {
    payload.expires_at = `${fieldExpire.value}T00:00:00`;
  }

  try {
    if (state.editingId) {
      await apiPut(`/api/licenses/${state.editingId}`, payload);
      showNotification('许可证更新成功', 'success');
    } else {
      await apiPost('/api/licenses', payload);
      showNotification('许可证创建成功', 'success');
    }
    toggleDialog(modal, false);
    await loadLicenses();
  } catch (error) {
    showNotification(error.message, 'error');
  }
});

exportBtn.addEventListener('click', async () => {
  try {
    const res = await apiDownload('/api/licenses/export');
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'licenses.csv';
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);
    showNotification('导出完成', 'success');
  } catch (error) {
    showNotification(error.message, 'error');
  }
});

async function loadLicenses() {
  try {
    const params = {};
    if (state.filters.search) params.search = state.filters.search;
    if (state.filters.status) params.status = state.filters.status;

    const res = await apiGet('/api/licenses', params);
    const data = res.data || {};
    state.licenses = data.items || [];
    renderTable();
  } catch (error) {
    state.licenses = [];
    renderTable();
    showNotification(error.message, 'error');
  }
}

loadLicenses().catch((error) => showNotification(error.message, 'error'));
</script>
{% endblock %}
